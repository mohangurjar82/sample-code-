<%= form_tag("/schedule", method: "post", id: "tvForm") do %>

<div class="container desktop">
	<div class="row category-board">

		<nav class="navbar navbar-default">
			<div class="container-fluid">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>						
					</button>

				</div>
				<div id="navbar" class="navbar-collapse collapse">
					
					<ul class="categories-links">
						<li><a class="active" href="#">POPULAR</a> <span class="sr-only">(current)</span></li>
						<li><a href="#">FREE</a></li>
						<li><a href="#">SATELLITE</a></li>
						<li><a href="#">MOVIES</a></li>
						<li><a href="#">SPORT</a></li>
						<li><a href="#">KIDS</a></li>
						<li><a href="#">DOCUMENTARIES</a></li>
						<li><a href="#">MUSIC</a></li>
						<li><a href="#">NEWS</a></li>

						<li class="last">
							<ul class="view-links">
								<li><a href="#">LIST VIEW</a></li>		
								<li><a class="active" href="#">GRID VIEW</a></li>	
							</ul>
						</li>
					</ul>				

					
				</div><!--/.nav-collapse -->
			</div><!--/.container-fluid -->
		</nav>
	</div>
	
	<div class="row search-board">
		<div class="col-md-3 date-board"><span></span></div>
		<div class="col-md-9">
			<div class="search-bar relative-pos">
				<div class="center" style="width: 100%">
					<div class="col-md-3">					
						<div id="custom-search-input">
                            <div class="input-group">
                                <input type="text" class="search-query form-control" placeholder="Search Listings"  id="listings-search-term" name="listings_search_term"/>
                                <span class="input-group-btn">
                                    <button class="btn btn-danger" type="button" id="listings-search-submit">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>
					</div>

					<div class="col-md-6 listings-details-column listings-date-time-search row">
						<div class="col-md-6">
							<select id="listings-date-picker-date-select" name="listings_date_picker_date_select" class="listings-picker-select"></select>
						</div>

						<div class="listings-date-picker-time-total col-md-6">
							
							<select id="listings-date-picker-time-select" class="listings-picker-select" name="listings_date_picker_time_select"><optgroup label="Quick Jump"><option value="17">Primetime</option><option value="now">Now</option></optgroup><optgroup label="Times"><option value="00">12:00 AM</option><option value="01">1:00 AM</option><option value="02">2:00 AM</option><option value="03">3:00 AM</option><option value="04">4:00 AM</option><option value="05">5:00 AM</option><option value="06">6:00 AM</option><option value="07">7:00 AM</option><option value="08">8:00 AM</option><option value="09">9:00 AM</option><option value="10">10:00 AM</option><option value="11">11:00 AM</option><option value="12">12:00 PM</option><option value="13">1:00 PM</option><option value="14">2:00 PM</option><option value="15">3:00 PM</option><option value="16">4:00 PM</option><option value="17">5:00 PM</option><option value="18">6:00 PM</option><option value="19">7:00 PM</option><option value="20">8:00 PM</option><option value="21">9:00 PM</option><option value="22">10:00 PM</option><option value="23">11:00 PM</option></optgroup></select>
						
							<button id="listings-date-time-picker-go" class="">GO</button>
						</div>
					</div>
					<div class="col-md-3 listings-details-column listings-details-preferences-column">
						<a href="#" onclick="return false" id="listings-favorites-button"  data-toggle="modal" data-target="#gridSystemModal"><i class="fa fa-heart fa-fw listings-button-icon"></i> Favorites</a>
						<a href="#" onclick="return false" id="listings-preferences-button"><i class="fa fa-gear fa-fw listings-button-icon"></i> Preferences</a>
					</div>
				</div>
			</div>
		</div>
	</div>
	
	
	<div class="row" id="yield-area">
		<div class="col-xs-1 arrow-common side-arrow-board">
			<a href="#"><span class="glyphicon glyphicon-triangle-left center" aria-hidden="true"></span></a>
		</div>
		
		<div class="col-xs-10">
			<div class="row arrow-common top-bottom-arrow-board">
				<a href="#"><span class="glyphicon glyphicon-triangle-top center" aria-hidden="true"></span></a>
			</div>

			<div class="row">
				<div class="col-xs-3 blank-space"></div>
				<div class="col-xs-9 time-board">
					<div class="col-xs-4 each-time">
						<span class="time">11</span>
						<span class="twelve">AM</span>						
					</div>	
					<div class="col-xs-4 each-time">
						<span class="time">12</span>
						<span class="twelve">PM</span>
					</div>
					<div class="col-xs-4 each-time">
						<span class="time">1</span>
						<span class="twelve">PM</span>
					</div>
				</div>
			</div>

			<div class="grid-view">
				
			</div>

			<div class="row arrow-common top-bottom-arrow-board">
				<a href="#"><span class="glyphicon glyphicon-triangle-bottom center" aria-hidden="true"></span></a>
			</div>
		</div>

		<div class="col-xs-1 arrow-common side-arrow-board">
			<a href="#"><span class="glyphicon glyphicon-triangle-right center" aria-hidden="true"></span></a>
		</div>
	</div>
	
</div>
<input type="hidden" name="cur_now" id="cur_now"></input>
<input type="hidden" name="utc_locale" id="utc_locale"></input>


<!-- Start: Favorite Modal Definition -->
<div id="gridSystemModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="gridModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="gridModalLabel">Favorite Channels</h4>
      </div>
      <div class="modal-body">
        <div class="container-fluid">
          
        </div>
      </div>
      <div class="modal-footer row">
      	<div class="listings-favorites-bulk-buttons col-md-6">
        	<button class="listings-favorites-bulk-button listings-favorites-bulk-add">
        		<span class="fa fa-plus"></span> Add All
        	</button> 
        	<button class="listings-favorites-bulk-button listings-favorites-bulk-remove">
        		<span class="fa fa-minus"></span> Remove All
        	</button>	
        </div>
        <div class="col-md-6">
	        <button type="button" class="btn btn-default" data-dismiss="modal">CANCEL</button>
	        <button type="button" class="btn btn-primary">SAVE FAVORITES</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- End: Favorite Modal Definition -->


<% end %>
<script type="text/javascript">
	$(document).ready(function(){
		
		// ---- Start: Declaration of variables and constants
		var js_tv_list;		
		var start_t;
		var search_time;
		var search_date_t;
		var tv_listing;		
		var channel_list;
		var select_time_val;
		var start_chan = 0;
		var end_chan = 6;
		var base_start_t; 
		var base_end_t;
		const channels_per_page = 7;
		// ---- End: Declaration of variables and constants

		function init_date_picker() {
			var tmp_html = '';	
			var loop_date = moment(start_t);

			for (var i = 0; i < 14; i++) {
				tmp_html = tmp_html + "<option value='" + loop_date.format('YYYY-MM-DD HH:mm:ss') + "'>" + loop_date.format("dddd, MMM D") + "</option>";
				loop_date = moment(loop_date).add(1, 'day');
			}

			$('#listings-date-picker-date-select').html(tmp_html);

			$('#listings-date-picker-date-select option[value="' + moment(search_date_t).format('YYYY-MM-DD HH:mm:ss') + '"]').attr("selected", "selected");
		}

		function init_time_picker() {
			$('#listings-date-picker-time-select option[value="' + select_time_val + '"]').attr("selected", "selected");
		}

		function initialize() {
      		$('#cur_now').val(moment().format('YYYY-MM-DD HH:mm:ss'));
			$('#utc_locale').val(moment().utcOffset());
			
			js_tv_list = {};
			start_t = "<%= raw @start_t %>";
			search_time = "<%= raw @search_time %>";
			search_date_t = "<%= raw @search_date_t %>";
			select_time_val = "<%= raw @select_time_val %>";

			tv_listing = <%= raw @tv_listing.to_json %>;

			channel_list = [];

			init_date_picker();
			init_time_picker();
			$("#listings-date-picker-date-select").select2({width: '100%'});
			$("#listings-date-picker-time-select").select2({width: '65%'});

			tv_listing.forEach(function(tv_channel) {
				if (Object.keys(js_tv_list).indexOf(tv_channel.channelNumber.toString()) === -1) {
					js_tv_list[tv_channel.channelNumber.toString()] = [];
					channel_list.push(tv_channel);
				}
				js_tv_list[tv_channel.channelNumber.toString()].push(tv_channel);
			});
			
			if(channel_list.length < channels_per_page) end_chan = channel_list.length - 1;

			start_t = moment(start_t);
			search_date_t = moment(search_date_t);
			search_time   = moment(search_time);
			end_t = moment(search_time).add(3, 'h');
		}

		initialize();

				
		$('.date-board span').html("Listings for " + moment(search_date_t).format("Do MMMM")); 

		base_start_t = moment(search_date_t); 
		base_end_t   = moment(base_start_t).add(24, 'h');

		function display_time_board(){
			var display_time = moment(search_time);

			$('.time-board .each-time').each(function(){
				$(this).find('.time').html(moment(display_time).format("h"));
				$(this).find('.twelve').html(display_time.format("A"));
				display_time = moment(display_time).add(1, 'h');
			});
		}

		display_time_board();
		
		function display_tv_listing(start, end) {
			$('.grid-view').html('');

			for(var c = start; c <= end; c++) {
				var channel = js_tv_list[channel_list[c].channelNumber];
				var cur_t;
				var next_t;
				var web_link;

				if(channel_list[c].webLink == "") 
					web_link = "#"
				else
					web_link = channel_list[c].webLink;

				var tmp_html = "<div class='row' id='" + channel_list[c].channelNumber + "'><div class='col-xs-3 channel-board'><div class='channel_info'><p class='channel_name'>" + channel_list[c].callsign + "</p><span>" + channel_list[c].channelNumber + "</span><p><a href='" + web_link + "'>watch now</a></p></div></div><div class='col-xs-9 program-board'></div></div>";
				$(tmp_html).appendTo(".grid-view");

				for(var i in channel)
				{
					cur_t = moment(channel[i].listDateTime, "YYYY-MM-DD HH:mm:ss");
					next_t = moment(cur_t).add(channel[i].duration, 'm');
					
				    if(next_t.diff(search_time) > 0 && cur_t.diff(end_t) < 0) {
				    	if(cur_t.diff(search_time) < 0) cur_t = moment(search_time, "YYYY-MM-DD HH:mm:ss");
				    	var tmp_html;
				    	var div_width_percent;
				    	var right_border = '';
				    	if(next_t.diff(end_t) >= 0) {
				    		div_width_percent = end_t.diff(cur_t, "m") / 180.0 * 100;
				    	}
				    	else {
				    		div_width_percent = next_t.diff(cur_t, "m") / 180.0 * 100;   	
				    		right_border = ' right-border';	
				    	}
				    	tmp_html = "<div class='pull-left" + right_border + "' style='width: " + div_width_percent + "%'><p class='show-type truncate'>" + channel[i].showType + "</p><p class='episode-title truncate'>" + channel[i].episodeTitle + "</p><p class='duration truncate'>" + moment(channel[i].listDateTime, "YYYY-MM-DD HH:mm:ss").format('h:mmA') + "-" + moment(next_t).format('h:mmA') + "</p></div>";
	
				    	$(tmp_html).appendTo('#' + channel_list[c].channelNumber + ' .program-board');
				    }
				}
			};
		};
		
		display_tv_listing(start_chan, end_chan);

		function clear_program_board(start, end) {
			for(var c = start; c <= end; c++) {
				$('#' + channel_list[c].channelNumber + ' .program-board').html('');
			};	
		};

		// When clicking left arrow link, it will display tv listing one hour ago from current time
		$('.glyphicon-triangle-left').click(function(){
			
			if(base_start_t.diff(search_time) == 0) return;
			
			search_time = moment(search_time).subtract(1, 'h');
			end_t 	= moment(end_t).subtract(1, 'h');
			
			clear_program_board(start_chan, end_chan);
			display_time_board();
			display_tv_listing(start_chan, end_chan);			
		});

		// When clicking right arrow link, it will display tv listing one hour after from current time
		$('.glyphicon-triangle-right').click(function(){
			if(base_end_t.diff(end_t) == 0) return;
			search_time = moment(search_time).add(1, 'h');
			end_t 	= moment(end_t).add(1, 'h');

			clear_program_board(start_chan, end_chan);
			display_time_board();
			display_tv_listing(start_chan, end_chan);
		});	

		// When clicking top arrow link, it will move to the previous page
		$('.glyphicon-triangle-top').click(function(){
			if(start_chan == 0) return;

			start_chan = start_chan - 7;
			end_chan = end_chan - (end_chan % channels_per_page) - 1;
			
			clear_program_board(start_chan, end_chan);
			display_time_board();
			display_tv_listing(start_chan, end_chan);
		});	

		// When clicking bottom arrow link, it will move to the next page
		$('.glyphicon-triangle-bottom').click(function(){
			if(end_chan == channel_list.length - 1) return;

			start_chan = start_chan + channels_per_page;
			if(end_chan +  channels_per_page > channel_list.length) 
				end_chan = channel_list.length - 1;
			else
				end_chan = end_chan + 7;

			clear_program_board(start_chan, end_chan);
			display_time_board();
			display_tv_listing(start_chan, end_chan);
		});		

		$('#listings-search-submit').on("click", function(){
			if($("#listings-search-term").val() == '') return;
			$('#tvForm').attr("action", "schedule/show");
			$('#tvForm').submit();
		});

		// When clicking 'GO' button for search with date and time, it will submit form data to the back-end
		$("#listings-date-time-picker-go").click(function(){
			$('#tvForm').submit();
		});

	
	});
</script>







