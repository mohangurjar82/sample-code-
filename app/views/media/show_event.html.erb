<% require 'date' %>
<% content_for :head do %>
  <script type="application/javascript" src="https://content.jwplatform.com/libraries/B2tmYadP.js"></script>
<% end %>
<div class="uk-panel media">
  <h1>
    <%= @media.title %>
    <div class="uk-panel-badge uk-badge"><%= @media.category_name %></div>
  </h1>
  <% if @hasNextEvent %>
    <h2>Upcoming Event</h2>
    <div class="eventdetails uk-grid">
      <div class="uk-width-1-3">
        <h2><%= @nextEvent.title %></h2>
        <%= @nextEvent.description %>
      </div>
      <div class="uk-width-1-3">
        <%= @nextEvent.start_date.strftime("%m/%d/%Y %H:%M") %>
        <div id="countdown"></div>
        <div id="event_start" style="display: none;"><%= @nextEvent.start_date.strftime("%m/%d/%Y %H:%M") %></div>
        <div id="current_date" style="display: none;"><%= Time.now.strftime("%m/%d/%Y %H:%M") %></div>
      </div>
      <div class="uk-width-1-3">
        <div id="event_price">$<%= @nextEvent.price / 100.0 %></div>
        <button id="purchase">Purchase</button>
      </div>
    </div>
    <script>

    window.onload = function () {
      var current_date = new Date($("#current_date").text());
      var start_date = new Date($("#event_start").text());

      window.setInterval(function () {
        var delta = Math.abs(start_date.valueOf() - current_date.valueOf()) / 1000;

        // calculate (and subtract) whole days
        var days = Math.floor(delta / 86400);
        delta -= days * 86400;

        // calculate (and subtract) whole hours
        var hours = Math.floor(delta / 3600) % 24;
        delta -= hours * 3600;

        // calculate (and subtract) whole minutes
        var minutes = Math.floor(delta / 60) % 60;
        delta -= minutes * 60;

        // what's left is seconds
        var seconds = delta % 60;

        $("#countdown").text(days + " days " + hours + "h " +
          minutes + "m " + seconds + "s");

        current_date.setSeconds(current_date.getSeconds() + 1);

        if (current_date.valueOf() > start_date.valueOf()) window.location.reload();
      }, 1000);
    };

    </script>
  <% end %>
  <div class="itemVideoEmbedded">
    <div id='player-area'>
      <% if @media.overlay.present? %>
          <p align="center"><a href="<%= @media.overlay_link %>" target="_blank">
          <img src="<%= @media.overlay %>" class="overlay">
        </a></p>
      <% end %>
      <% if @media.file_url.nil? %>
        <desc><%= @media.description.html_safe %></desc>
      <% else %>
        <% if @media.file_url.length > 0 %>
          <%= render 'media/player', media: @media %>
        <% else %>
          <%= @media.description.html_safe %>
        <% end %>
      <% end %>
    </div>
    <% if @mobile %>
      <a href="?flash">Switch to Flash player</a>
    <% end %>
  </div>
</div>
